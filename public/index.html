<!DOCTYPE html>  
<html>
<head>

    <!-- CSS LIBRARIES-->
        <link rel="stylesheet" type="text/css" href="bower_components/bootstrap/dist/css/bootstrap.min.css">

    <!-- CUSTOM CSS -->
        <link rel="stylesheet" type="text/css" href="css/main.css">

    <!-- JS LIBRARIES -->
        
        <script src="/socket.io/socket.io.js"></script>
        <script src="https://code.jquery.com/jquery-2.2.4.min.js" integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44=" crossorigin="anonymous"></script>
        <!-- <script src="bower_components/angular/angular.min.js"></script> -->
    <script>
                
    </script>
</head>
<body>
    <div class="container">

                <div id="intro">
                    <label for="nickname">Write your nickname</label>
                    <input type="text" name="nickname" id="nickname">
                    <button id="readyBtn">I'm ready!</button>    
                </div>
                

                <div id="game-view">
                    <div class="container">
                        <div class="row">
                            <div class="player-box" id="player-box">
                                <div class="player-info">
                            
                                    <p id="player-name" class="player-name"></p>

                                    <div class="bet-section">
                                        
                                        <input type="number" name="bet" id="bet-val">
                                        <button id="bet-btn">Make bet</button>    
                                    </div>
                                    <br>
                                </div>
                                <div class="player-hand" >

                                </div>
                            </div>          
                        </div>

                        <div class="row">
                                <div class="opponent-box" id="opponent0">
                                    <div class="player-info">
                                        <p class="player-name"></p>
                                    </div>
                                    <div class="player-hand" >

                                    </div>
                                </div>

                            
                                <div class="table" id="#table">
                                    
                                </div>
                            

                                <div class="opponent-box" id="opponent1">
                                    <div class="player-info">
                                        <p class="player-name"></p>
                                    </div>
                                    <div class="player-hand" >

                                    </div>
                                </div>
                            
                        </div>

                        <div class="row">
                            
                                <div class="opponent-box" id="opponent2">
                                    <div class="player-info">
                                        <p class="player-name"></p>
                                    </div>
                                    <div class="player-hand" >

                                    </div>
                                </div>
                        </div>
                    </div>    
                </div>
    </div>  

    <script>

        var socket = io();
        socket.emit('connection');
        console.log('I am connected!');

        var mainPlayer = {};
        
        var opponents = [];
        $(document).ready(function() {
            $('#game-view').hide();

            //ready
            $("#readyBtn").click(function() {
                console.log('Ready!');
                socket.emit('ready', $("#nickname").val());
                $("#readyBtn").prop('disabled', true);   
            });  

            //bet
            $('#bet-btn').click(function() {
                socket.emit("betDone", $('#bet-val').val());
                $('.bet-section').hide();
                console.log("My bet is " + $('#bet-val').val());
            });  

            //move
            $('#player-box').on('click', '.hand-item', function () {
                console.log('btn clicked!');
                socket.emit('makeMove', $(this).data("id"));
                console.log("Your move is " + $(this).data("id"));
                $(this).remove();
                $('#player-box .hand-item').prop('disabled', true);

            });
        });

        

        socket.on('setMainPlayer', function (newPlayer) {
            mainPlayer = newPlayer;
        });

        socket.on('sitToTable', function (nickname, opponentsInGame){
            //things to hide
            $('#intro').hide();
            $('.bet-section').hide();

            //"sitting" already existing opponents to table
            opponents = opponentsInGame;
            renderStartOpponents(opponents);

            $('#game-view').show();
            $('#player-name').text(nickname);
        });

        socket.on('opponentConnected', function (opponent) {
            opponents.push(opponent);
            console.log("Opponent " + opponent.name + " joined the game!");
            switch(opponents.length) {
                case 1:
                    $('#opponent0').find('.player-name').text(opponent.name);
                    $('#opponent0').attr('data-id', opponent.id);
                    $('#opponent0').addClass('active');
                    break;
                case 2:
                    $('#opponent1').find('.player-name').text(opponent.name);
                    $('#opponent1').attr('data-id', opponent.id);
                    $('#opponent1').addClass('active');
                    break;
                case 3:
                    $('#opponent2').find('.player-name').text(opponent.name);
                    $('#opponent2').attr('data-id', opponent.id);
                    $('#opponent2').addClass('active');
                    break;
            }
            console.log(opponents);
        });

        socket.on('setHand', function (hand) {
            mainPlayer.hand = hand;
            console.log('My hand is: ');
            for (var i in mainPlayer.hand) {
                console.log(mainPlayer.hand[i]);
                //draw player's hand with item's id in data-id
                $('.player-box .player-hand').append("<button data-id='" + mainPlayer.hand[i].id + "' class='hand-item'>" + mainPlayer.hand[i].id + "</button>");
                $('#player-box .hand-item').prop('disabled', true);
                
                $('.opponent-box.active .player-hand').append("<button>" + "xx" + "</button>");
            }
        })


        //bet process
        socket.on('askBet', function () {
            console.log('Make your bet!');
            $('.bet-section').show();
        });

        socket.on('opponentMove', function (opponentId) {
            $('.opponent-box').filter('[data-id="' + opponentId + '"]').find('.player-hand button:first').remove();
        });

        //move process
        socket.on('askMove', function () {
            console.log("It's your turn. Make your best move!");
            $('#player-box .hand-item').prop('disabled', false);
        });

        function findOpponent(opponentId) {
            for(var i in opponents) {
                if(opponentId == opponents[i])
                    return opponents[i];
            }
        }

        function renderStartOpponents(opponents) {
            for(var i in opponents){
                var opponentByIndex = "#opponent" + i;
                $(opponentByIndex).find('.player-name').text(opponents[i].name);
                $(opponentByIndex).attr('data-id', opponents[i].id);
                $(opponentByIndex).addClass('active');
            };
        }
    
    </script>
</body>
</html>